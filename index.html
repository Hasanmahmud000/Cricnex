<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>Live Stream Player</title>
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/shaka-player.compiled.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { background: #000; color: #fff; font-family: sans-serif; margin: 0; text-align: center; }
    video { width: 100%; max-width: 800px; background: black; }
    #team-logos img { max-height: 60px; margin: 0 10px; vertical-align: middle; }
    #countdown, #notice { margin: 10px 0; font-size: 18px; }
    #watermark-text {
      position: fixed;
      right: 10px;
      bottom: 10px;
      font-size: 14px;
      color: rgba(255,255,255,0.6);
      background: rgba(0,0,0,0.5);
      padding: 4px 8px;
      border-radius: 4px;
      z-index: 1000;
      pointer-events: none;
    }
    #controls { margin-top: 5px; display: flex; justify-content: center; gap: 15px; align-items: center; }
    #qualitySelector, #muteBtn, #pipBtn {
      background: #222; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 14px; cursor: pointer;
    }
    .overlay { background: rgba(0,0,0,0.7); padding: 5px; position: absolute; top: 5px; left: 5px; z-index: 10; }
  </style>
</head>
<body>
  <img id="logo" alt="Logo" />
  <div id="team-logos">
    <img id="team1" alt="Team 1" />
    <img id="team2" alt="Team 2" />
  </div>
  <h2 id="match-title">Live Match</h2>
  <div id="countdown">Loading...</div>
  <marquee id="notice">Loading notice...</marquee>

  <div style="position:relative; max-width:800px; margin: auto;">
    <video id="video" controls autoplay playsinline crossorigin="anonymous"></video>
    <div class="overlay" id="status">Initializing...</div>
  </div>

  <div id="controls">
    <button id="muteBtn">Mute üîá</button>
    <button id="pipBtn">PiP ‚ñ∂Ô∏è</button>
    <select id="qualitySelector" style="display:none;"></select>
  </div>

  <img id="sponsor" style="width: 100%; margin-top: 15px; max-height: 90px; object-fit: contain" />
  <div id="watermark-text">BDStreamHub</div>

  <script>
    const c = JSON.parse(localStorage.getItem("liveConfig") || "{}");
    const start = c.startTime ? new Date(c.startTime).getTime() : Date.now();

    document.getElementById("logo").src = c.logo || "";
    document.getElementById("team1").src = c.team1 || "";
    document.getElementById("team2").src = c.team2 || "";
    document.getElementById("sponsor").src = c.sponsor || "";
    document.getElementById("notice").innerText = c.notice || "";
    document.getElementById("match-title").innerText = c.matchTitle || "Live Match";

    function tick() {
      const diff = start - Date.now();
      const ctn = document.getElementById("countdown");
      if (diff > 0) {
        const m = Math.floor(diff / 60000), s = Math.floor((diff % 60000) / 1000);
        ctn.innerText = `‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶¨‡ßá ${m}‡¶Æ‡¶ø ${s}‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá`;
      } else {
        ctn.innerText = "üî¥ LIVE ‡¶ö‡¶≤‡¶õ‡ßá";
      }
    }
    setInterval(tick, 1000); tick();

    const vid = document.getElementById("video"),
          st = document.getElementById("status"),
          muteBtn = document.getElementById("muteBtn"),
          pipBtn = document.getElementById("pipBtn"),
          qualitySelector = document.getElementById("qualitySelector");

    muteBtn.onclick = () => {
      vid.muted = !vid.muted;
      muteBtn.textContent = vid.muted ? "Unmute üîà" : "Mute üîá";
    };

    pipBtn.onclick = async () => {
      try {
        if (document.pictureInPictureElement) {
          await document.exitPictureInPicture();
        } else {
          await vid.requestPictureInPicture();
        }
      } catch (e) {
        alert("Picture-in-Picture ‡¶Æ‡ßã‡¶° ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡¶Ø‡¶º‡•§");
      }
    };

    async function loadShaka(stream, licenseUrl) {
      shaka.polyfill.installAll();
      const player = new shaka.Player(vid);

      if (licenseUrl) {
        player.configure({ drm: { servers: { "com.widevine.alpha": licenseUrl } } });
      }

      player.getNetworkingEngine().registerRequestFilter((type, req) => {
        if (type === shaka.net.NetworkingEngine.RequestType.LICENSE) {
          req.headers["Referer"] = location.origin;
        }
      });

      await player.load(stream);
      st.innerText = "‚ñ∂Ô∏è LIVE (DASH DRM)";

      const tracks = player.getVariantTracks();
      qualitySelector.innerHTML = "";
      const uniq = [];
      tracks.forEach(t => {
        if (!uniq.some(q => q.height === t.height)) uniq.push(t);
      });

      uniq.sort((a, b) => a.height - b.height);
      uniq.forEach(track => {
        const opt = document.createElement("option");
        opt.value = track.id;
        opt.text = `${track.height}p (${Math.round(track.bandwidth / 1000)} kbps)`;
        qualitySelector.appendChild(opt);
      });

      if (uniq.length > 1) qualitySelector.style.display = "inline-block";
      qualitySelector.onchange = () => {
        const id = parseInt(qualitySelector.value);
        player.selectVariantTrack(player.getVariantTracks().find(t => t.id === id), true);
      };
    }

    async function loadHLS(stream) {
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(stream);
        hls.attachMedia(vid);
        st.innerText = "‚ñ∂Ô∏è LIVE (HLS)";
        hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
          if (data.levels.length > 1) {
            qualitySelector.innerHTML = "";
            data.levels.forEach((lvl, i) => {
              const opt = document.createElement("option");
              opt.value = i;
              opt.text = `${lvl.height}p`;
              qualitySelector.appendChild(opt);
            });
            qualitySelector.style.display = "inline-block";
            qualitySelector.onchange = () => {
              hls.currentLevel = parseInt(qualitySelector.value);
            };
          }
        });
      } else {
        vid.src = stream;
        st.innerText = "‚ñ∂Ô∏è LIVE (MP4)";
      }
    }

    (async () => {
      vid.muted = false; // Start with sound on
      muteBtn.textContent = "Mute üîá";
      if (c.stream) {
        if (c.stream.includes(".mpd")) {
          await loadShaka(c.stream, c.license);
        } else {
          await loadHLS(c.stream);
        }
      } else {
        st.innerText = "‚ùå Stream URL Not Found!";
      }
    })();
  </script>
</body>
</html>
